<template>
  <div class="home-container">
    <!-- ÂàùÂßãÁä∂ÊÄÅ - Ê¨¢ËøéÈ°µÈù¢ -->
    <div v-if="!hasData && !isLoading && !hasStartedChat" class="initial-view">
      <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è - ÈÄèÊòéÂå∫Âüü (ÂàùÂßãÁä∂ÊÄÅ) -->
      <div class="top-toolbar">
        <div class="toolbar-left">
          <ConversationHistory ref="conversationHistoryRef" @select-conversation="handleSelectConversation"
            @new-conversation="handleNewChat" />
          <v-btn icon size="small" variant="text" class="new-chat-btn" @click="handleNewChat">
            <v-icon>mdi-plus</v-icon>
          </v-btn>
          <ModelSelector />
        </div>
        <div class="toolbar-right">
          <DatasetList ref="datasetListRef" @select-dataset="handleDatasetSelect" />
        </div>
      </div>

      <!-- Â±Ö‰∏≠ÂÜÖÂÆπÂÆπÂô® -->
      <div class="center-content">
        <!-- Ê¨¢ËøéÂç°Áâá -->
        <div class="welcome-section">
          <v-card title="Ê¨¢Ëøé‰ΩøÁî®Áè†Êµ∑ÁßëÊäÄÂ±Ä Chat BI" subtitle="ËøôÊòØ‰∏Ä‰∏™ÂÆûÈ™åÁéØÂ¢ÉÔºåÂõûÁ≠îÂèØËÉΩÊúâËØØÔºåËØ∑Ê≥®ÊÑèÁîÑÂà´!">
            <template v-slot:prepend>
              <v-icon color="primary" size="large">mdi-message-text</v-icon>
            </template>
          </v-card>
        </div>

        <!-- ËæìÂÖ•Ê°Ü -->
        <div class="input-center-section">
          <div class="input-center-wrapper">
            <ChatInput v-model="inputValue" :disabled="isLoading" :rows="2" tool-menu-position="bottom"
              :selected-datasets="selectedDatasets" @send="sendRequest" @tool-select="handleToolSelect"
              @upload-click="uploadDialogVisible = true" @remove-dataset="handleRemoveDataset" @preview-dataset="handlePreviewDataset" />
          </div>
        </div>
      </div>

    </div>

    <!-- ÂØπËØùÁä∂ÊÄÅ - ÂÜÖÂÆπÂå∫ÂüüÂèØÊªöÂä® + ËæìÂÖ•Ê°ÜÂõ∫ÂÆöÂ∫ïÈÉ® -->
    <div v-else class="conversation-view">
      <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è - ÈÄèÊòéÂå∫Âüü -->
      <div class="top-toolbar-conversation">
        <div class="toolbar-left">
          <ConversationHistory @select-conversation="handleSelectConversation" @new-conversation="handleNewChat" />
          <v-btn icon size="small" variant="text" class="new-chat-btn" @click="handleNewChat">
            <v-icon>mdi-plus</v-icon>
          </v-btn>
          <ModelSelector />
        </div>
        <div class="toolbar-right">
          <DatasetList ref="datasetListRef" @select-dataset="handleDatasetSelect" />
        </div>
      </div>

      <!-- ÂÜÖÂÆπÂå∫Âüü - ÂèØÊªöÂä® -->
      <div class="content-area" ref="contentArea">
        <div class="content-wrapper">
          <!-- Áªü‰∏ÄÊ∂àÊÅØÊòæÁ§∫Âå∫Âüü -->
          <div v-if="hasStartedChat || hasData" class="messages-list">
            <!-- ÊòæÁ§∫ÊâÄÊúâÊ∂àÊÅØÔºàÂéÜÂè≤+‰∏¥Êó∂Ôºâ -->
            <template v-if="displayMessages.length > 0">
              <template v-for="(message, index) in displayMessages" :key="message.id || `temp-${index}`">
                <!-- Áî®Êà∑Ê∂àÊÅØ -->
                <div v-if="message.role === 'user'" class="message-item user-message">
                  <div class="user-bubble">
                    <p class="text-sm">{{ message.content }}</p>
                  </div>
                </div>

                <!-- AIÂä©ÊâãÊ∂àÊÅØ -->
                <div v-else-if="message.role === 'assistant'" class="message-item ai-message">
                  <!-- Â§ÑÁêÜÊ≠•È™§ÊåáÁ§∫Âô®(‰ªÖÂú®Âä†ËΩΩ‰∏≠ÊòæÁ§∫) -->
                  <ProcessingSteps v-if="isLoading && showProcessingSteps" :current-step="currentProcessingStep"
                    :error="processingError" class="mb-4" />

                  <!-- ÂõæË°®Â±ïÁ§∫ -->
                  <v-card v-if="message.chart_data" class="mb-4">
                    <!-- ÂõæË°®Á±ªÂûãÂàáÊç¢ÊåâÈíÆ -->
                    <v-card-title class="d-flex justify-space-between align-center">
                      <span>Êï∞ÊçÆÂèØËßÜÂåñ</span>
                      <div class="chart-controls">
                        <v-btn-toggle v-model="message.chart_data.display_mode" mandatory 
                          variant="flat" density="compact" class="chart-toggle-group">
                          <v-btn value="chart" size="small" class="chart-toggle-btn">
                            <v-icon size="16">mdi-chart-bar</v-icon>
                            <span class="ml-1">ÂõæË°®</span>
                          </v-btn>
                          <v-btn value="table" size="small" class="chart-toggle-btn">
                            <v-icon size="16">mdi-table</v-icon>
                            <span class="ml-1">Ë°®Ê†º</span>
                          </v-btn>
                        </v-btn-toggle>
                      </div>
                    </v-card-title>
                    <v-card-text>
                      <!-- ÂõæË°®ËßÜÂõæ -->
                      <div v-if="message.chart_data.display_mode === 'chart' || !message.chart_data.display_mode">
                        <!-- Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàÁöÑÂõæË°®ÈÖçÁΩÆ -->
                        <div v-if="Object.keys(buildChartOptions(message.chart_data)).length > 0">
                          <EChart :options="buildChartOptions(message.chart_data)" :loading="false"
                            v-model="message.chart_data.chart_type" class="chart"
                            @update:modelValue="handleChartTypeChange(message, $event)" />
                        </div>
                        <!-- Â¶ÇÊûúÊó†Ê≥ïÁîüÊàêÂõæË°®ÈÖçÁΩÆÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ -->
                        <div v-else class="text-center py-8 text-gray-500">
                          <v-icon size="48" class="mb-2">mdi-chart-bar</v-icon>
                          <p>Ê≠§Êï∞ÊçÆÊöÇ‰∏çÊîØÊåÅÂõæË°®Â±ïÁ§∫ÔºåËØ∑ÂàáÊç¢Âà∞Ë°®Ê†ºËßÜÂõæ</p>
                        </div>
                      </div>
                      <!-- Ë°®Ê†ºËßÜÂõæ -->
                      <div v-else-if="message.chart_data.display_mode === 'table'">
                        <DataTable :data="message.chart_data.data || []" :items-per-page="10" />
                      </div>
                    </v-card-text>
                  </v-card>

                  <!-- Ê¥ûÂØüÂàÜÊûêÂç°Áâá - Âä†ËΩΩ‰∏≠Âç≥ÊòæÁ§∫ÔºàÈ™®Êû∂Â±è/ÊµÅÂºèÂÜÖÂÆπÔºâ -->
                  <v-card v-if="message.chart_data && isAnalysisLoading" class="mb-4 insight-analysis-card">
                    <v-card-title class="d-flex align-center">
                      <v-icon color="primary" class="mr-2">mdi-lightbulb-on</v-icon>
                      <span>Êï∞ÊçÆÊ¥ûÂØüÂàÜÊûê</span>
                    </v-card-title>
                    <v-card-text>
                      <!-- È™®Êû∂Â±èÂä†ËΩΩÁä∂ÊÄÅ -->
                      <div v-if="isAnalysisLoading && !streamingAnalysis" class="insight-skeleton">
                        <v-skeleton-loader type="paragraph" class="mb-3"></v-skeleton-loader>
                        <v-skeleton-loader type="sentences" class="mb-3"></v-skeleton-loader>
                        <v-skeleton-loader type="paragraph"></v-skeleton-loader>
                      </div>

                      <!-- ÊµÅÂºèËæìÂá∫ÂÜÖÂÆπ - ÊâìÂ≠óÊú∫ÊïàÊûú -->
                      <div v-else-if="streamingAnalysis" class="streaming-content">
                        <div class="prose dark:prose-invert max-w-none">
                          <MarkdownRenderer :content="streamingAnalysis" />
                        </div>
                        <!-- ÊâìÂ≠óÊú∫ÂÖâÊ†áÊïàÊûú -->
                        <span v-if="!isAnalysisComplete" class="typing-cursor">|</span>
                      </div>
                    </v-card-text>
                  </v-card>

                  <!-- ÂéÜÂè≤ÂØπËØù‰∏≠ÁöÑÊ¥ûÂØüÂàÜÊûêÂÜÖÂÆπ - ‰ªÖÂú®ÈùûÊµÅÂºèÁä∂ÊÄÅÊó∂ÊòæÁ§∫ -->
                  <v-card v-else-if="message.role === 'assistant' && message.content && message.content.includes('## üìä Êï∞ÊçÆÊ¥ûÂØüÂàÜÊûê') && !isAnalysisLoading" class="mb-4 insight-analysis-card">
                    <v-card-title class="d-flex align-center">
                      <v-icon color="primary" class="mr-2">mdi-lightbulb-on</v-icon>
                      <span>Êï∞ÊçÆÊ¥ûÂØüÂàÜÊûê</span>
                    </v-card-title>
                    <v-card-text>
                      <div class="prose dark:prose-invert max-w-none">
                        <MarkdownRenderer :content="message.content" />
                      </div>
                    </v-card-text>
                  </v-card>

                  <!-- AIÂõûÂ§çÂÜÖÂÆπ - ÊéíÈô§Ê¥ûÂØüÂàÜÊûêÂÜÖÂÆπ -->
                  <v-card v-if="message.content && !message.content.includes('## üìä Êï∞ÊçÆÊ¥ûÂØüÂàÜÊûê')" class="mb-4">
                    <v-card-text>
                      <div class="prose dark:prose-invert max-w-none">
                        <MarkdownRenderer :content="message.content" />
                      </div>
                    </v-card-text>
                  </v-card>

                  <!-- Êìç‰ΩúÊåâÈíÆÂíåÊó∂Èó¥‰ø°ÊÅØ -->
                  <div class="action-bar">
                    <div class="action-buttons">
                      <v-btn icon size="small" variant="text" class="action-icon-btn">
                        <v-icon size="18">mdi-refresh</v-icon>
                      </v-btn>
                      <v-btn icon size="small" variant="text" class="action-icon-btn">
                        <v-icon size="18">mdi-content-copy</v-icon>
                      </v-btn>
                      <v-btn icon size="small" variant="text" class="action-icon-btn">
                        <v-icon size="18">mdi-thumb-up-outline</v-icon>
                      </v-btn>
                      <v-btn icon size="small" variant="text" class="action-icon-btn">
                        <v-icon size="18">mdi-thumb-down-outline</v-icon>
                      </v-btn>
                    </div>
                    <!-- Âè≥‰æßÊó∂Èó¥‰ø°ÊÅØÂå∫Âüü -->
                    <div class="time-info">
                      <!-- AIÂõûÂ§çÊó∂Èó¥ -->
                      <div class="message-time">
                        <v-icon size="16">mdi-calendar-clock</v-icon>
                        <span>{{ formatMessageTime(message.created_at) }}</span>
                      </div>
                      <!-- ÂìçÂ∫îÊó∂Èó¥ -->
                      <div v-if="message.response_time" class="response-time">
                        <v-icon size="16">mdi-clock-outline</v-icon>
                        <span>{{ (message.response_time / 1000).toFixed(1) }}s</span>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </template>
          </div>
        </div>
      </div>

      <!-- ÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆ - Âõ∫ÂÆöÂú®ËæìÂÖ•Ê°Ü‰∏äÊñπ -->
      <Transition name="fade">
        <div v-if="showScrollToBottom" class="scroll-to-bottom-container">
          <v-btn color="primary" size="small" elevation="2" class="scroll-to-bottom-btn" @click="scrollToBottom(true)">
            <v-icon size="18">mdi-arrow-down</v-icon>
            <span class="ml-1">ÊªöÂä®Âà∞ÊúÄÊñ∞</span>
          </v-btn>
        </div>
      </Transition>

      <!-- ËæìÂÖ•Âå∫Âüü - Âõ∫ÂÆöÂú®Â∫ïÈÉ® -->
      <div class="input-bar">
        <div class="input-wrapper">
          <ChatInput v-model="inputValue" :disabled="isLoading" :rows="1" tool-menu-position="top"
            :selected-datasets="selectedDatasets" @send="sendRequest" @tool-select="handleToolSelect"
            @upload-click="uploadDialogVisible = true" @remove-dataset="handleRemoveDataset" @preview-dataset="handlePreviewDataset" />
        </div>
      </div>

      <!-- Â∫ïÈÉ®ÂÖçË¥£Â£∞Êòé - ÈÄèÊòé -->
      <div class="disclaimer-footer">
        <span class="disclaimer-text">AI ÁîüÊàêÂÜÖÂÆπÂèØËÉΩ‰∏çÂáÜÁ°ÆÔºåËØ∑‰ªîÁªÜÊ†∏ÂÆû„ÄÇ</span>
      </div>
    </div>

    <!-- Êñá‰ª∂‰∏ä‰º†ÂØπËØùÊ°Ü -->
    <FileUploadDialog v-model="uploadDialogVisible" @upload-success="handleUploadSuccess" />
  </div>
</template>

<script setup lang="ts">
import { ref, computed, nextTick, onMounted, onUnmounted, watch } from 'vue'
import axios from 'axios'
import EChart from './EChart.vue'
import MarkdownRenderer from './MarkdownRenderer.vue'
import ChatInput from './ChatInput.vue'
import ConversationHistory from './ConversationHistory.vue'
import ModelSelector from './ModelSelector.vue'
import DatasetList from './DatasetList.vue'
import FileUploadDialog from './FileUploadDialog.vue'
import ProcessingSteps from './ProcessingSteps.vue'
import DataTable from './DataTable.vue'

const inputValue = ref('')
const lastUserMessage = ref('')  // ‰øùÂ≠òÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
const hasData = ref(false)
const isLoading = ref(false)
const hasStartedChat = ref(false)
const hasChartData = ref(false)  // Êñ∞Â¢û: ÊòØÂê¶ÊúâÂõæË°®Êï∞ÊçÆ
const chartOptions = ref({})
const chartType = ref<'bar' | 'line' | 'pie' | 'doughnut'>('bar')
const responseTime = ref<number | null>(null)
const insightAnalysis = ref<string | null>(null)
const streamingAnalysis = ref<string>('')
const isAnalysisLoading = ref(false)
const isAnalysisComplete = ref(false)
const uploadDialogVisible = ref(false)
const datasetListRef = ref()
const conversationHistoryRef = ref()
const selectedDatasets = ref<Dataset[]>([])

// Â§ÑÁêÜÊ≠•È™§Áõ∏ÂÖ≥
const currentProcessingStep = ref<string>('')
const processingError = ref<string>('')
const showProcessingSteps = ref(false)

// Ê∂àÊÅØÂàóË°®Áõ∏ÂÖ≥
interface Message {
  id: number
  role: 'user' | 'assistant'
  content: string
  chart_data?: any
  chart_type?: string
  response_time?: number
  created_at: string
  insight_task_id?: string  // Ê¥ûÂØüÂàÜÊûê‰ªªÂä°ID
}

const messageList = ref<Message[]>([])  // Â≠òÂÇ®ÂÆåÊï¥ÁöÑÊ∂àÊÅØÂàóË°®
const currentConversationId = ref<number | null>(null)  // ÂΩìÂâç‰ºöËØùID
const isStreaming = ref(false)  // ÊòØÂê¶Ê≠£Âú®ÊµÅÂºèËæìÂá∫
const tempUserMessage = ref<Message | null>(null)  // ‰∏¥Êó∂Áî®Êà∑Ê∂àÊÅØ
const tempAiMessage = ref<Message | null>(null)  // ‰∏¥Êó∂AIÊ∂àÊÅØÔºàÁî®‰∫éÊµÅÂºèÊõ¥Êñ∞Ôºâ

// ÂêàÂπ∂ÂéÜÂè≤Ê∂àÊÅØÂíå‰∏¥Êó∂Ê∂àÊÅØÁî®‰∫éÊòæÁ§∫
const displayMessages = computed(() => {
  const messages = [...messageList.value]

  // Â¶ÇÊûúÊúâ‰∏¥Êó∂Ê∂àÊÅØÔºåÊ∑ªÂä†Âà∞Êú´Â∞æ
  if (tempUserMessage.value) {
    messages.push(tempUserMessage.value)
  }
  if (tempAiMessage.value) {
    messages.push(tempAiMessage.value)
  }

  return messages
})

// ÊªöÂä®Áõ∏ÂÖ≥
const contentArea = ref<HTMLElement>()
const showScrollToBottom = ref(false)  // ÊòØÂê¶ÊòæÁ§∫ÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆ

interface Dataset {
  id: string
  name: string
  logical_name?: string
  row_count: number
  column_count: number
}

interface RefinedData {
  x_axis: string
  y_axes: string[]
  scale: string
  unit: string
}

const sendRequest = async () => {
  if (!inputValue.value) {
    alert('ËØ∑ËæìÂÖ•ÈóÆÈ¢ò')
    return
  }

  // ‰øùÂ≠òÁî®Êà∑ËæìÂÖ•(ÂèëÈÄÅÂâç)
  const userQuestion = inputValue.value
  lastUserMessage.value = userQuestion  // ‰øùÂ≠òÂà∞lastUserMessageÁî®‰∫éÊòæÁ§∫

  // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü - ‰ΩøÁî®Â§öÊ¨°Á°Æ‰øùÊ∏ÖÈô§
  inputValue.value = ''

  // ‰ΩøÁî® nextTick Á°Æ‰øù DOM Êõ¥Êñ∞ÂêéÂÜçÊ¨°Ê∏ÖÁ©∫
  await nextTick()
  inputValue.value = ''

  // Â¶ÇÊûúÂΩìÂâçÊ≤°Êúâ‰ºöËØùIDÔºåÂÖàÂàõÂª∫Êñ∞‰ºöËØùÔºàÂè™Âú®Á¨¨‰∏ÄÊ¨°ÂèëÈÄÅÊ∂àÊÅØÊó∂ÂàõÂª∫Ôºâ
  if (!currentConversationId.value) {
    const newConvId = await createNewConversation()
    if (!newConvId) {
      alert('ÂàõÂª∫‰ºöËØùÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')
      return
    }
    console.log('È¶ñÊ¨°ÂèëÈÄÅÊ∂àÊÅØÔºåÂ∑≤ÂàõÂª∫Êñ∞‰ºöËØù:', newConvId)
  } else {
    console.log('‰ΩøÁî®Áé∞Êúâ‰ºöËØù:', currentConversationId.value)
  }

  // ÂàõÂª∫‰∏¥Êó∂Áî®Êà∑Ê∂àÊÅØÁ´ãÂç≥ÊòæÁ§∫
  tempUserMessage.value = {
    id: Date.now(),  // ‰∏¥Êó∂ID
    role: 'user',
    content: userQuestion,
    created_at: new Date().toISOString()
  }

  // ÂàõÂª∫‰∏¥Êó∂AIÊ∂àÊÅØÔºàÂàùÂßã‰∏∫Á©∫Ôºâ
  tempAiMessage.value = {
    id: Date.now() + 1,  // ‰∏¥Êó∂ID
    role: 'assistant',
    content: '',
    created_at: new Date().toISOString()
  }

  // Ê†áËÆ∞ÂØπËØùÂ∑≤ÂºÄÂßã
  hasStartedChat.value = true
  isStreaming.value = true

  // ÈáçÁΩÆÂΩìÂâçÊ∂àÊÅØÁöÑÊòæÁ§∫Áä∂ÊÄÅÔºà‰ΩÜ‰∏çÊ∏ÖÁ©∫ currentConversationIdÔºâ
  isLoading.value = true
  hasData.value = false
  hasChartData.value = false  // ÈáçÁΩÆÂõæË°®Êï∞ÊçÆÊ†áÂøó
  responseTime.value = null
  insightAnalysis.value = null
  streamingAnalysis.value = ''
  isAnalysisLoading.value = false
  isAnalysisComplete.value = false
  const startTime = performance.now()

  // ÈáçÁΩÆÂ§ÑÁêÜÊ≠•È™§
  currentProcessingStep.value = ''
  processingError.value = ''
  showProcessingSteps.value = false

  // Âà§Êñ≠ÊòØÂê¶ËøõÂÖ•Êô∫ÊÖßÈóÆÊï∞Ê®°Âºè
  const isSmartQueryMode = selectedDatasets.value.length > 0

  console.log(`Ê®°Âºè: ${isSmartQueryMode ? 'Êô∫ÊÖßÈóÆÊï∞' : 'ÊôÆÈÄöÂØπËØù'}`)
  console.log('Â∑≤ÈÄâÊã©Êï∞ÊçÆÈõÜ:', selectedDatasets.value)

  try {
    // Â¶ÇÊûúÊòØÊôÆÈÄöÂØπËØùÊ®°Âºè(Êú™ÈÄâÊã©Êï∞ÊçÆÈõÜ),Áõ¥Êé•Ë∞ÉÁî®ÊµÅÂºèAIÂØπËØù
    if (!isSmartQueryMode) {
      console.log('ÊôÆÈÄöÂØπËØùÊ®°Âºè - Ë∞ÉÁî®ÊµÅÂºèAIÂØπËØù')
      hasData.value = true
      hasChartData.value = false  // ÊôÆÈÄöÂØπËØùÊ®°Âºè‰∏çÊòæÁ§∫ÂõæË°®
      await fetchStreamingChatResponse(userQuestion)
      const endTime = performance.now()
      responseTime.value = Math.round(endTime - startTime)
      isLoading.value = false
      return
    }

    // Êô∫ÊÖßÈóÆÊï∞Ê®°Âºè - ÊòæÁ§∫Â§ÑÁêÜÊ≠•È™§Âπ∂Ë∞ÉÁî®ÂõæË°®ÁîüÊàêAPI
    console.log('Êô∫ÊÖßÈóÆÊï∞Ê®°Âºè - Ë∞ÉÁî®ÂõæË°®ÁîüÊàêAPI')
    showProcessingSteps.value = true

    // ÂàùÂßãÂåñËøõÂ∫¶Áä∂ÊÄÅ
    currentProcessingStep.value = 'intent'
    processingError.value = ''

    const response = await axios.post(`${import.meta.env.VITE_API_BASE_URL}/api/generate_chart`, {
      user_input: userQuestion,
      user_id: 1,  // ‰∏¥Êó∂‰ΩøÁî®Âõ∫ÂÆöÁî®Êà∑ID
      dataset_ids: selectedDatasets.value.map((d: any) => d.id)  // ‰º†ÈÄíÁî®Êà∑ÈÄâ‰∏≠ÁöÑÊï∞ÊçÆÈõÜIDÂàóË°®
    })

    console.log('Response:', response.data)
    const responseData = response.data

    // Ëé∑Âèñ‰ªªÂä°IDÂπ∂ËÆ¢ÈòÖËøõÂ∫¶Êõ¥Êñ∞
    const taskId = responseData.task_id
    if (taskId) {
      subscribeToProgress(taskId)
    }

    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØÊ†áËØÜ
    if (responseData.is_error || responseData.error) {
      throw new Error(responseData.message || responseData.error || 'Êú™Áü•ÈîôËØØ')
    }

    // Ê£ÄÊü•ÂìçÂ∫îÁ±ªÂûã
    if (responseData.type === 'text') {
      // Â§ÑÁêÜÊñáÊú¨ÂìçÂ∫î(Èó≤ËÅäÁ≠â)
      console.log('Êî∂Âà∞ÊñáÊú¨ÂìçÂ∫î:', responseData.message)
      hasData.value = true
      streamingAnalysis.value = responseData.message
      showProcessingSteps.value = false
      return
    }

    const { data, refined_data, chart_type, visualization_type, insight_task_id } = responseData

    if (data && data.length > 0) {
      hasData.value = true
      showProcessingSteps.value = false  // ÈöêËóèÂ§ÑÁêÜÊ≠•È™§ÔºåÊòæÁ§∫ÁªìÊûú

      // Ê†πÊçÆÂèØËßÜÂåñÁ±ªÂûãËøõË°å‰∏çÂêåÂ§ÑÁêÜ
      if (visualization_type === 'table') {
        // Ë°®Ê†ºÁ±ªÂûãÔºö‰∏çÊòæÁ§∫ÂõæË°®ÔºåÂè™ÊòæÁ§∫Êï∞ÊçÆ
        hasChartData.value = false
        console.log('Êï∞ÊçÆÁ±ªÂûã‰∏∫tableÔºåË∑≥ËøáÂõæË°®Ê∏≤Êüì')
        
        // Â∞ÜË°®Ê†ºÊï∞ÊçÆÊ∑ªÂä†Âà∞‰∏¥Êó∂AIÊ∂àÊÅØ
        if (tempAiMessage.value) {
          tempAiMessage.value.chart_data = {
            data: data,
            refined_data: null,
            chart_type: null,
            display_mode: 'table'  // Ë°®Ê†ºÊòæÁ§∫Ê®°Âºè
          }

          // ‰øùÂ≠òÊ¥ûÂØüÂàÜÊûê‰ªªÂä°ID
          if (insight_task_id) {
            tempAiMessage.value.insight_task_id = insight_task_id
            console.log('‰øùÂ≠òÊ¥ûÂØüÂàÜÊûê‰ªªÂä°ID:', insight_task_id)
          }
        }
      } else {
        // ÂõæË°®Á±ªÂûãÔºöÊòæÁ§∫ÂõæË°®
        hasChartData.value = true
        
        // Ê£ÄÊü•refined_dataÊòØÂê¶Â≠òÂú®
        if (!refined_data || !refined_data.x_axis || !refined_data.y_axes) {
          console.warn('refined_data‰∏çÂÆåÊï¥Ôºå‰ΩøÁî®Ëá™Âä®Êé®Êñ≠ÊûÑÂª∫ÂõæË°®')
          // ‰ΩøÁî®buildChartOptionsÁöÑËá™Âä®Êé®Êñ≠ÈÄªËæë
          chartOptions.value = buildChartOptions({
            data: data,
            refined_data: null,
            chart_type: chart_type || 'bar',
            visualization_type: 'chart'
          })
          chartType.value = chart_type || 'bar'
        } else {
          // ‰ΩøÁî®refined_dataÊûÑÂª∫ÂõæË°®
          const refinedData = refined_data as RefinedData
          console.log('Refined Data:', refinedData)

          const xAxisData = data.map((item: any) => item[refinedData.x_axis])
          console.log('xAxisData:', xAxisData)

          const seriesData = refined_data.y_axes.map((yAxis: string) => {
            return {
              name: yAxis,
              type: chart_type || 'bar',
              data: data.map((item: any) => item[yAxis]),
              stack: chart_type === 'bar' ? 'x' : undefined,
              areaStyle: chart_type === 'line' ? {} : undefined
            }
          })
          console.log('Series Data:', seriesData)

          chartOptions.value = {
            xAxis: {
              type: 'category',
              data: xAxisData,
            },
            yAxis: {
              type: 'value',
            },
            series: seriesData,
            legend: {
              data: refined_data.y_axes
            },
            tooltip: {
              trigger: 'axis'
            }
          }
          chartType.value = chart_type || 'bar'
        }
        
        console.log('Chart Options:', chartOptions.value)
        console.log('Chart Type:', chartType.value)

        // Â∞ÜÂõæË°®Êï∞ÊçÆÊ∑ªÂä†Âà∞‰∏¥Êó∂AIÊ∂àÊÅØ
        if (tempAiMessage.value) {
          tempAiMessage.value.chart_data = {
            data: data,
            refined_data: refined_data,
            chart_type: chart_type,
            display_mode: 'chart'  // ÂõæË°®ÊòæÁ§∫Ê®°Âºè
          }

          // ‰øùÂ≠òÊ¥ûÂØüÂàÜÊûê‰ªªÂä°ID
          if (insight_task_id) {
            tempAiMessage.value.insight_task_id = insight_task_id
            console.log('‰øùÂ≠òÊ¥ûÂØüÂàÜÊûê‰ªªÂä°ID:', insight_task_id)
          }
        }
      }

      // Â¶ÇÊûúÊúâ‰ªªÂä°IDÔºå‰ΩøÁî®ËΩÆËØ¢ÊñπÂºèËé∑ÂèñÊ¥ûÂØüÂàÜÊûêÔºõÂê¶Âàô‰ΩøÁî®ÊµÅÂºèÊñπÂºè
      if (insight_task_id) {
        console.log('‰ΩøÁî®‰ªªÂä°IDËΩÆËØ¢ÊñπÂºèËé∑ÂèñÊ¥ûÂØüÂàÜÊûê:', insight_task_id)
        pollInsightAnalysisTask(insight_task_id)
      } else {
        // ÂºÄÂßãÊµÅÂºèÊ¥ûÂØüÂàÜÊûêÔºàÂÖºÂÆπÊóßÁâàÊú¨Ôºâ
        console.log('‰ΩøÁî®ÊµÅÂºèÊñπÂºèËé∑ÂèñÊ¥ûÂØüÂàÜÊûê...')
        fetchStreamingInsightAnalysis()
      }
    } else {
      hasData.value = false
      console.warn('Êú™Ëé∑ÂèñÂà∞ÂõæË°®Êï∞ÊçÆ')
    }
  } catch (error: any) {
    console.error('ËØ∑Ê±ÇÂ§±Ë¥•', error)
    hasData.value = false

    // ÊèêÂèñËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ
    let errorTitle = 'ÁîüÊàêÂõæË°®Â§±Ë¥•'
    let errorDetail = ''
    let errorSuggestions: string[] = []

    if (error.response?.data) {
      const errorData = error.response.data

      // ‰ΩøÁî®ÂêéÁ´ØËøîÂõûÁöÑÁªìÊûÑÂåñÈîôËØØ‰ø°ÊÅØ
      if (errorData.title) {
        errorTitle = errorData.title
      } else {
        errorTitle = errorData.error || errorTitle
      }

      errorDetail = errorData.message || errorData.detail || ''

      // Ëé∑ÂèñÂêéÁ´ØËøîÂõûÁöÑÂª∫ËÆÆ
      if (errorData.suggestions && Array.isArray(errorData.suggestions)) {
        errorSuggestions = errorData.suggestions
      }

      // Â§ÑÁêÜÂêéÁ´ØËøîÂõûÁöÑÂÖ∑‰ΩìÈîôËØØÁ±ªÂûã
      if (errorData.error_type) {
        switch (errorData.error_type) {
          case 'column_not_found':
            if (!errorData.title) errorTitle = 'Êï∞ÊçÆÂàóÊú™ÊâæÂà∞'
            break
          case 'connection_error':
            if (!errorData.title) errorTitle = 'ÁΩëÁªúËøûÊé•ÈîôËØØ'
            break
          case 'sql_error':
            if (!errorData.title) errorTitle = 'Êï∞ÊçÆÊü•ËØ¢ÈîôËØØ'
            break
          case 'ai_model_error':
            if (!errorData.title) errorTitle = 'AIÊúçÂä°ÈîôËØØ'
            break
          case 'dataset_error':
            if (!errorData.title) errorTitle = 'Êï∞ÊçÆÈõÜÂ§ÑÁêÜÈîôËØØ'
            break
          case 'permission_error':
            if (!errorData.title) errorTitle = 'ÊùÉÈôê‰∏çË∂≥'
            break
        }
      }

      // ÂÖºÂÆπÊóßÁöÑÈîôËØØÁ±ªÂûãÂ§ÑÁêÜ
      if (errorData.type === 'validation_error') {
        errorTitle = 'Êï∞ÊçÆÈ™åËØÅÈîôËØØ'
      } else if (errorData.type === 'database_error') {
        errorTitle = 'Êï∞ÊçÆÂ∫ìÊü•ËØ¢ÈîôËØØ'
      } else if (errorData.type === 'ai_model_error') {
        errorTitle = 'AIÊ®°ÂûãË∞ÉÁî®ÈîôËØØ'
      }
    } else if (error.message) {
      errorDetail = error.message
    } else {
      errorDetail = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËÆæÁΩÆ'
    }

    // Ê†áËÆ∞Â§ÑÁêÜÊ≠•È™§ÈîôËØØ
    processingError.value = errorDetail
    showProcessingSteps.value = true

    // Âú®ÂØπËØùÂå∫ÂüüÊòæÁ§∫ÂèãÂ•ΩÁöÑÈîôËØØÊ∂àÊÅØ
    let friendlyErrorMessage = `### ‚ùå ${errorTitle}\n\n`

    if (errorDetail) {
      friendlyErrorMessage += `${errorDetail}\n\n`
    }

    // ÊòæÁ§∫Âª∫ËÆÆÊìç‰Ωú
    if (errorSuggestions.length > 0) {
      friendlyErrorMessage += '**Âª∫ËÆÆÊìç‰ΩúÔºö**\n'
      errorSuggestions.forEach((suggestion, index) => {
        friendlyErrorMessage += `${index + 1}. ${suggestion}\n`
      })
    } else {
      // Â¶ÇÊûúÊ≤°ÊúâÂêéÁ´ØÂª∫ËÆÆÔºå‰ΩøÁî®ÈªòËÆ§Âª∫ËÆÆ
      if (errorDetail.includes('Referenced column') && errorDetail.includes('not found')) {
        friendlyErrorMessage += '**Âª∫ËÆÆÊìç‰ΩúÔºö**\n'
        friendlyErrorMessage += '1. ËØ∑Á®çÂêéÈáçËØïÊÇ®ÁöÑÊü•ËØ¢\n'
        friendlyErrorMessage += '2. ÊàñËÄÖÂ∞ùËØïÈáçÊñ∞‰∏ä‰º†Êï∞ÊçÆÊñá‰ª∂\n'
        friendlyErrorMessage += '3. Á°Æ‰øùÊï∞ÊçÆÊñá‰ª∂‰∏≠ÁöÑÂàóÂêç‰∏çÂåÖÂê´ÁâπÊÆäÁ¨¶Âè∑'
      } else if (errorDetail.includes('ÁΩëÁªú') || errorDetail.includes('ËøûÊé•')) {
        friendlyErrorMessage += 'ÁΩëÁªúËøûÊé•Âá∫Áé∞ÈóÆÈ¢òÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•ÂêéÈáçËØï„ÄÇ'
      } else if (errorDetail.includes('Ê®°Âûã') || errorDetail.includes('AI')) {
        friendlyErrorMessage += 'AIÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ'
      } else {
        friendlyErrorMessage += '**Âª∫ËÆÆÊìç‰ΩúÔºö**\n'
        friendlyErrorMessage += '1. Ê£ÄÊü•ÊÇ®ÁöÑËæìÂÖ•ÊòØÂê¶Ê≠£Á°Æ\n'
        friendlyErrorMessage += '2. Á®çÂêéÈáçËØï\n'
        friendlyErrorMessage += '3. Â¶ÇÊûúÈóÆÈ¢òÊåÅÁª≠Â≠òÂú®ÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò'
      }
    }

    streamingAnalysis.value = friendlyErrorMessage
    hasData.value = true  // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØÂå∫Âüü

    // Êõ¥Êñ∞‰∏¥Êó∂AIÊ∂àÊÅØ‰ª•ÊòæÁ§∫ÈîôËØØ
    if (tempAiMessage.value) {
      tempAiMessage.value.content = friendlyErrorMessage
    }

  } finally {
    const endTime = performance.now()
    responseTime.value = Math.round(endTime - startTime)
    isLoading.value = false
  }
}

const fetchInsightAnalysis = async () => {
  try {
    const response = await axios.get(`${import.meta.env.VITE_API_BASE_URL}/api/insight_analysis`, {
      params: { user_input: inputValue.value }
    })
    insightAnalysis.value = response.data.insight_analysis
  } catch (error) {
    console.error('Ëé∑ÂèñÊ¥ûÂØüÂàÜÊûêÂ§±Ë¥•', error)
  }
}

// ËΩÆËØ¢Ê¥ûÂØüÂàÜÊûê‰ªªÂä°Áä∂ÊÄÅ
const pollInsightAnalysisTask = async (taskId: string) => {
  console.log('ÂºÄÂßãËΩÆËØ¢Ê¥ûÂØüÂàÜÊûê‰ªªÂä°:', taskId)
  isAnalysisLoading.value = true
  isAnalysisComplete.value = false

  const maxAttempts = 60 // ÊúÄÂ§öËΩÆËØ¢60Ê¨° (5ÂàÜÈíü)
  const pollInterval = 5000 // ÊØè5ÁßíËΩÆËØ¢‰∏ÄÊ¨°
  let attempts = 0

  const poll = async () => {
    try {
      attempts++
      console.log(`ËΩÆËØ¢Ê¥ûÂØüÂàÜÊûê‰ªªÂä°Áä∂ÊÄÅ (${attempts}/${maxAttempts}):`, taskId)

      const response = await axios.get(`${import.meta.env.VITE_API_BASE_URL}/api/insight_task/${taskId}`)
      const { status, result, error } = response.data

      console.log('‰ªªÂä°Áä∂ÊÄÅ:', status, 'ÁªìÊûú:', result ? 'Â∑≤Ëé∑Âèñ' : 'Êó†', 'ÈîôËØØ:', error)

      if (status === 'completed' && result) {
        // ‰ªªÂä°ÂÆåÊàêÔºåÈáçÊñ∞Âä†ËΩΩÂØπËØùÊ∂àÊÅØ‰ª•Ëé∑Âèñ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÁöÑÊ¥ûÂØüÂàÜÊûê
        isAnalysisLoading.value = false
        isAnalysisComplete.value = true
        console.log('Ê¥ûÂØüÂàÜÊûêÂÆåÊàê:', result)
        
        // ÈáçÊñ∞Âä†ËΩΩÂØπËØùÊ∂àÊÅØ‰ª•Ëé∑Âèñ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÁöÑÊ¥ûÂØüÂàÜÊûê
        if (currentConversationId.value) {
          console.log('ÈáçÊñ∞Âä†ËΩΩÂØπËØùÊ∂àÊÅØ‰ª•Ëé∑ÂèñÊ¥ûÂØüÂàÜÊûê...')
          await reloadConversationMessages()
          // Ê∏ÖÁ©∫ÊµÅÂºèÂàÜÊûêÂÜÖÂÆπÔºåÁ°Æ‰øùÂéÜÂè≤Ê¥ûÂØüÂàÜÊûêËÉΩÊ≠£Á°ÆÊòæÁ§∫
          streamingAnalysis.value = ''
        }
        return
      } else if (status === 'failed') {
        // ‰ªªÂä°Â§±Ë¥•
        console.error('Ê¥ûÂØüÂàÜÊûê‰ªªÂä°Â§±Ë¥•:', error)
        isAnalysisLoading.value = false
        isAnalysisComplete.value = false
        return
      } else if (status === 'running' && attempts < maxAttempts) {
        // ‰ªªÂä°‰ªçÂú®ËøêË°åÔºåÁªßÁª≠ËΩÆËØ¢
        setTimeout(poll, pollInterval)
      } else if (attempts >= maxAttempts) {
        // Ë∂ÖÊó∂
        console.error('Ê¥ûÂØüÂàÜÊûê‰ªªÂä°ËΩÆËØ¢Ë∂ÖÊó∂')
        isAnalysisLoading.value = false
        isAnalysisComplete.value = false
      }
    } catch (error) {
      console.error('ËΩÆËØ¢Ê¥ûÂØüÂàÜÊûê‰ªªÂä°Â§±Ë¥•:', error)
      if (attempts < maxAttempts) {
        // Âá∫ÈîôÊó∂ÁªßÁª≠ÈáçËØï
        setTimeout(poll, pollInterval)
      } else {
        isAnalysisLoading.value = false
        isAnalysisComplete.value = false
      }
    }
  }

  // ÂºÄÂßãËΩÆËØ¢
  poll()
}

const fetchStreamingChatResponse = async (userQuestion: string) => {
  if (!userQuestion) return

  console.log('ÂºÄÂßãÊµÅÂºèÂØπËØùÔºåÂΩìÂâçconversation_id:', currentConversationId.value)
  streamingAnalysis.value = ''
  insightAnalysis.value = null
  isAnalysisLoading.value = true
  isAnalysisComplete.value = false

  try {
    // Ë∞ÉÁî®ÊôÆÈÄöÂØπËØùAPI (‰ΩøÁî®Áé∞ÊúâÁöÑÊµÅÂºèÂàÜÊûêÁ´ØÁÇπ,‰ΩÜ‰∏ç‰º†Êï∞ÊçÆ)
    const response = await fetch(`${import.meta.env.VITE_API_BASE_URL}/api/insight_analysis_stream`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_input: userQuestion,
        data: JSON.stringify({
          userQuestion: userQuestion,
          mode: 'chat',  // Ê†áËÆ∞‰∏∫Á∫ØËÅäÂ§©Ê®°Âºè
          conversation_id: currentConversationId.value || null,  // ‰º†ÈÄíÂΩìÂâçÂØπËØùIDÔºåÁ°Æ‰øù‰∏∫nullËÄå‰∏çÊòØundefined
          timestamp: new Date().toISOString()
        })
      })
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    if (!response.body) {
      throw new Error('Response body is null')
    }

    const reader = response.body.getReader()
    const decoder = new TextDecoder()

    while (true) {
      const { done, value } = await reader.read()

      if (done) {
        isAnalysisComplete.value = true
        isAnalysisLoading.value = false
        break
      }

      const chunk = decoder.decode(value, { stream: true })
      const lines = chunk.split('\n')

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const data = JSON.parse(line.slice(6))

            if (data.content) {
              streamingAnalysis.value += data.content
              // ÂÆûÊó∂Êõ¥Êñ∞‰∏¥Êó∂AIÊ∂àÊÅØ
              if (tempAiMessage.value) {
                tempAiMessage.value.content += data.content
              }
            } else if (data.done) {
              isAnalysisComplete.value = true
              isAnalysisLoading.value = false
            } else if (data.error) {
              console.error('ÊµÅÂºèÂØπËØùÈîôËØØ:', data.error)
              isAnalysisComplete.value = true
              isAnalysisLoading.value = false
              streamingAnalysis.value += '\n\nÂá∫Áé∞ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï'
              if (tempAiMessage.value) {
                tempAiMessage.value.content += '\n\nÂá∫Áé∞ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï'
              }
              break
            }
          } catch (e) {
            console.debug('Ëß£ÊûêÊµÅÊï∞ÊçÆÂá∫Èîô:', e)
          }
        }
      }
    }

    // ÊµÅÂºèËæìÂá∫ÂÆåÊàêÂêéÔºåÈáçÊñ∞Âä†ËΩΩÂØπËØùÊ∂àÊÅØÂàóË°®
    if (currentConversationId.value) {
      await reloadConversationMessages()
      // Ê∏ÖÁ©∫ÊµÅÂºèÂàÜÊûêÂÜÖÂÆπÔºåÁ°Æ‰øùÂéÜÂè≤Ê¥ûÂØüÂàÜÊûêËÉΩÊ≠£Á°ÆÊòæÁ§∫
      streamingAnalysis.value = ''
    }

  } catch (error) {
    console.error('ÊµÅÂºèÂØπËØùÂ§±Ë¥•:', error)
    isAnalysisComplete.value = true
    isAnalysisLoading.value = false
    streamingAnalysis.value = 'Êä±Ê≠âÔºåÂØπËØùÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ'
  }
}

const fetchStreamingInsightAnalysis = async () => {
  console.log('=== ÂºÄÂßãÊ¥ûÂØüÂàÜÊûêÊµÅÁ®ã ===')
  console.log('ÂΩìÂâçÁä∂ÊÄÅÊ£ÄÊü•:')
  console.log('- inputValue:', inputValue.value)
  console.log('- chartOptions:', chartOptions.value)
  console.log('- hasData:', hasData.value)
  console.log('- tempAiMessage:', tempAiMessage.value)

  if (!inputValue.value) {
    console.log('‚ùå inputValue‰∏∫Á©∫ÔºåÈÄÄÂá∫ÂáΩÊï∞')
    return
  }

  console.log('‚úÖ ÂºÄÂßãËÆæÁΩÆÁä∂ÊÄÅÂèòÈáè...')
  streamingAnalysis.value = ''
  insightAnalysis.value = null
  isAnalysisLoading.value = true
  isAnalysisComplete.value = false

  console.log('‚úÖ Áä∂ÊÄÅÂèòÈáèËÆæÁΩÆÂÆåÊàê:', {
    streamingAnalysis: streamingAnalysis.value,
    insightAnalysis: insightAnalysis.value,
    isAnalysisLoading: isAnalysisLoading.value,
    isAnalysisComplete: isAnalysisComplete.value
  })

  try {
    const requestUrl = `${import.meta.env.VITE_API_BASE_URL}/api/insight_analysis_stream`
    const requestBody = {
      user_input: inputValue.value,
      data: JSON.stringify({
        chartData: chartOptions.value,
        userQuestion: inputValue.value,
        timestamp: new Date().toISOString(),
        mode: 'analysis',  // Ê†áËÆ∞‰∏∫Ê¥ûÂØüÂàÜÊûêÊ®°Âºè
        conversation_id: currentConversationId.value  // ‰º†ÈÄíÂΩìÂâçÂØπËØùID
      })
    }

    console.log('üì° ÂáÜÂ§áÂèëÈÄÅËØ∑Ê±Ç:')
    console.log('- URL:', requestUrl)
    console.log('- Body:', requestBody)

    const response = await fetch(requestUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestBody)
    })

    console.log('üì• Êî∂Âà∞ÂìçÂ∫î:', {
      status: response.status,
      ok: response.ok,
      headers: Object.fromEntries(response.headers.entries())
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    if (!response.body) {
      throw new Error('Response body is null')
    }

    const reader = response.body.getReader()
    const decoder = new TextDecoder()

    console.log('üîÑ ÂºÄÂßãËØªÂèñÊµÅÂºèÊï∞ÊçÆ...')
    let chunkCount = 0
    while (true) {
      const { done, value } = await reader.read()

      if (done) {
        console.log('‚úÖ ÊµÅÂºèÊï∞ÊçÆËØªÂèñÂÆåÊàêÔºåÊÄªÂÖ±Â§ÑÁêÜ‰∫Ü', chunkCount, '‰∏™Êï∞ÊçÆÂùó')
        isAnalysisComplete.value = true
        isAnalysisLoading.value = false
        break
      }

      chunkCount++
      const chunk = decoder.decode(value, { stream: true })
      console.log(`üì¶ Êî∂Âà∞Á¨¨${chunkCount}‰∏™Êï∞ÊçÆÂùó:`, chunk)
      const lines = chunk.split('\n')

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const dataStr = line.slice(6)
            console.log('üîç Ëß£ÊûêÊï∞ÊçÆÂ≠óÁ¨¶‰∏≤:', dataStr)
            const data = JSON.parse(dataStr)
            console.log('‚úÖ Ëß£ÊûêÊàêÂäüÁöÑÊï∞ÊçÆ:', data)

            // Â§ÑÁêÜÂêéÁ´ØËøîÂõûÁöÑ‰∏çÂêåÊï∞ÊçÆÊ†ºÂºè
            if (data.content) {
              // Â§ÑÁêÜÊµÅÂºèÂÜÖÂÆπ
              const oldLength = streamingAnalysis.value.length
              streamingAnalysis.value += data.content
              console.log(`üìù Êõ¥Êñ∞streamingAnalysis: ${oldLength} -> ${streamingAnalysis.value.length} Â≠óÁ¨¶`)
              console.log('üìù Êñ∞Â¢ûÂÜÖÂÆπ:', data.content)

              // ÂÆûÊó∂Êõ¥Êñ∞‰∏¥Êó∂AIÊ∂àÊÅØ
              if (tempAiMessage.value) {
                tempAiMessage.value.content += data.content
                console.log('üìù ÂêåÊ≠•Êõ¥Êñ∞tempAiMessage')
              }
            } else if (data.delta && data.delta.content) {
              // Â§ÑÁêÜOpenAIÊ†ºÂºèÁöÑdeltaÂÜÖÂÆπ
              const oldLength = streamingAnalysis.value.length
              streamingAnalysis.value += data.delta.content
              console.log(`üìù Êõ¥Êñ∞streamingAnalysis (delta): ${oldLength} -> ${streamingAnalysis.value.length} Â≠óÁ¨¶`)
              if (tempAiMessage.value) {
                tempAiMessage.value.content += data.delta.content
              }
            } else if (data.choices && data.choices[0] && data.choices[0].delta && data.choices[0].delta.content) {
              // Â§ÑÁêÜOpenAI APIÊ†ºÂºèÁöÑchoices.delta.content
              const content = data.choices[0].delta.content
              const oldLength = streamingAnalysis.value.length
              streamingAnalysis.value += content
              console.log(`üìù Êõ¥Êñ∞streamingAnalysis (choices): ${oldLength} -> ${streamingAnalysis.value.length} Â≠óÁ¨¶`)
              if (tempAiMessage.value) {
                tempAiMessage.value.content += content
              }
            } else if (data.done || (data.choices && data.choices[0] && data.choices[0].finish_reason)) {
              console.log('üèÅ Êî∂Âà∞ÂÆåÊàê‰ø°Âè∑')
              isAnalysisComplete.value = true
              isAnalysisLoading.value = false
            } else if (data.error) {
              console.error('‚ùå ÊµÅÂºèÂàÜÊûêÈîôËØØ:', data.error)
              isAnalysisComplete.value = true
              isAnalysisLoading.value = false
              streamingAnalysis.value += '\n\nÂá∫Áé∞ÈîôËØØÔºåÊ≠£Âú®Â∞ùËØïËé∑ÂèñÁºìÂ≠òÁöÑÂàÜÊûêÁªìÊûú...'
              if (tempAiMessage.value) {
                tempAiMessage.value.content += '\n\nÂá∫Áé∞ÈîôËØØÔºåÊ≠£Âú®Â∞ùËØïËé∑ÂèñÁºìÂ≠òÁöÑÂàÜÊûêÁªìÊûú...'
              }
              setTimeout(fetchInsightAnalysis, 1000)
              break
            } else {
              // Â§ÑÁêÜÂÖ∂‰ªñÂèØËÉΩÁöÑÊï∞ÊçÆÊ†ºÂºè
              console.log('‚ö†Ô∏è Êî∂Âà∞Êú™Â§ÑÁêÜÁöÑÊï∞ÊçÆÊ†ºÂºè:', data)
            }
          } catch (e) {
            console.debug('‚ö†Ô∏è Ëß£ÊûêÊµÅÊï∞ÊçÆÂá∫Èîô:', e, 'ÂéüÂßãÊï∞ÊçÆ:', line)
          }
        }
      }
    }

    // ÊµÅÂºèËæìÂá∫ÂÆåÊàêÂêéÔºåÈáçÊñ∞Âä†ËΩΩÂØπËØùÊ∂àÊÅØÂàóË°®
    if (currentConversationId.value) {
      console.log('üîÑ ÈáçÊñ∞Âä†ËΩΩÂØπËØùÊ∂àÊÅØÂàóË°®...')
      await reloadConversationMessages()
      // Ê∏ÖÁ©∫ÊµÅÂºèÂàÜÊûêÂÜÖÂÆπÔºåÁ°Æ‰øùÂéÜÂè≤Ê¥ûÂØüÂàÜÊûêËÉΩÊ≠£Á°ÆÊòæÁ§∫
      streamingAnalysis.value = ''
      // Â¶ÇÊûúÊòØÊñ∞‰ºöËØùÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØÔºåËá™Âä®ÁîüÊàêÊ†áÈ¢ò
      await generateConversationTitleIfNeeded()
    }

  } catch (error) {
    console.error('‚ùå ÊµÅÂºèÊ¥ûÂØüÂàÜÊûêÂ§±Ë¥•:', error)
    isAnalysisComplete.value = true
    isAnalysisLoading.value = false
    streamingAnalysis.value = ''
    fetchInsightAnalysis()
  }

  console.log('=== Ê¥ûÂØüÂàÜÊûêÊµÅÁ®ãÁªìÊùü ===')
}

const handleToolSelect = (action: string) => {
  console.log('Â∑•ÂÖ∑ÈÄâÊã©:', action)
  // ËøôÈáåÂèØ‰ª•Â§ÑÁêÜ‰∏çÂêåÂ∑•ÂÖ∑ÁöÑÈÄªËæë
  switch (action) {
    case 'upload':
      console.log('‰∏ä‰º†Êñá‰ª∂')
      break
    case 'create-image':
      console.log('ÂàõÂª∫ÂõæÁâá')
      break
    case 'think-longer':
      console.log('ÊÄùËÄÉÊó∂Èó¥Êõ¥Èïø')
      break
    case 'deep-research':
      console.log('Ê∑±Â∫¶Á†îÁ©∂')
      break
    case 'study':
      console.log('Á†îÁ©∂‰∏éÂ≠¶‰π†')
      break
    case 'more':
      console.log('Êõ¥Â§öÈÄâÈ°π')
      break
    default:
      console.log('Êú™Áü•Êìç‰Ωú:', action)
  }
}

// ÂàõÂª∫Êñ∞‰ºöËØù
const createNewConversation = async () => {
  try {
    const response = await axios.post(
      `${import.meta.env.VITE_API_BASE_URL}/api/conversation/create`,
      {
        user_id: 1,
        title: 'Êñ∞ÂØπËØù'
      }
    )

    if (response.data.success) {
      currentConversationId.value = response.data.conversation_id
      console.log('Êñ∞‰ºöËØùÂ∑≤ÂàõÂª∫:', currentConversationId.value)
      return currentConversationId.value
    }
  } catch (error) {
    console.error('ÂàõÂª∫Êñ∞‰ºöËØùÂ§±Ë¥•:', error)
  }
  return null
}

// Êñ∞Â¢û‰ºöËØù
const handleNewChat = () => {
  // ÈáçÁΩÆÊâÄÊúâÁä∂ÊÄÅÂõûÂà∞ÂàùÂßãÈ°µÈù¢
  inputValue.value = ''
  lastUserMessage.value = ''
  hasData.value = false
  hasChartData.value = false
  isLoading.value = false
  hasStartedChat.value = false
  chartOptions.value = {}
  chartType.value = 'bar'
  responseTime.value = null
  insightAnalysis.value = null
  streamingAnalysis.value = ''
  isAnalysisLoading.value = false
  isAnalysisComplete.value = false
  selectedDatasets.value = []
  // Ê∏ÖÁ©∫Ê∂àÊÅØÂàóË°®
  messageList.value = []
  // Ê∏ÖÁ©∫‰∏¥Êó∂Ê∂àÊÅØ
  tempUserMessage.value = null
  tempAiMessage.value = null
  isStreaming.value = false
  // ÈáçÁΩÆÂΩìÂâç‰ºöËØùIDÔºà‰∏ãÊ¨°ÂèëÈÄÅÊ∂àÊÅØÊó∂‰ºöËá™Âä®ÂàõÂª∫Êñ∞‰ºöËØùÔºâ
  currentConversationId.value = null
  // ÈáçÁΩÆÂ§ÑÁêÜÊ≠•È™§
  currentProcessingStep.value = ''
  processingError.value = ''
  showProcessingSteps.value = false

  console.log('Â∑≤ÈáçÁΩÆÂà∞ÂàùÂßãÁä∂ÊÄÅÔºå‰∏ãÊ¨°ÂèëÈÄÅÊ∂àÊÅØÊó∂Â∞ÜÂàõÂª∫Êñ∞‰ºöËØù')
}

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÁöÑÂàùÂßãÂåñ
onMounted(async () => {
  if (contentArea.value) {
    contentArea.value.addEventListener('scroll', handleScroll)
  }

  // Âà∑Êñ∞È°µÈù¢‰∏çÂàõÂª∫‰ºöËØùÔºå‰øùÊåÅÂàùÂßãÁä∂ÊÄÅ
  console.log('È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÁ≠âÂæÖÁî®Êà∑Êìç‰Ωú')
})

// Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†ÊàêÂäü
const handleUploadSuccess = async (datasetId: string) => {
  console.log('Êñá‰ª∂‰∏ä‰º†ÊàêÂäüÔºåÊï∞ÊçÆÈõÜID:', datasetId)

  // Âà∑Êñ∞Êï∞ÊçÆÈõÜÂàóË°®
  if (datasetListRef.value) {
    datasetListRef.value.refreshDatasets()
  }

  // Ëé∑Âèñ‰∏ä‰º†ÁöÑÊï∞ÊçÆÈõÜËØ¶ÊÉÖÂπ∂Ëá™Âä®Ê∑ªÂä†Âà∞ÈÄâ‰∏≠ÂàóË°®
  try {
    const response = await axios.get(
      `${import.meta.env.VITE_API_BASE_URL}/api/dataset/${datasetId}/status`
    )
    const dataset = response.data
    handleDatasetSelect({
      id: dataset.dataset_id,
      name: dataset.name,
      logical_name: dataset.logical_name,
      row_count: dataset.row_count || 0,
      column_count: dataset.column_count || 0
    })
  } catch (error) {
    console.error('Ëé∑ÂèñÊï∞ÊçÆÈõÜËØ¶ÊÉÖÂ§±Ë¥•:', error)
  }
}

// Â§ÑÁêÜÊï∞ÊçÆÈõÜÈÄâÊã© - ÊîØÊåÅÂ§öÈÄâ
const handleDatasetSelect = (dataset: Dataset) => {
  console.log('ÈÄâÊã©Êï∞ÊçÆÈõÜ:', dataset)

  // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÈÄâ‰∏≠
  const index = selectedDatasets.value.findIndex(d => d.id === dataset.id)
  if (index === -1) {
    // Êú™ÈÄâ‰∏≠,Ê∑ªÂä†Âà∞ÂàóË°®
    selectedDatasets.value.push(dataset)
  } else {
    // Â∑≤ÈÄâ‰∏≠,‰∏çÈáçÂ§çÊ∑ªÂä†
    console.log('Êï∞ÊçÆÈõÜÂ∑≤Âú®ÈÄâ‰∏≠ÂàóË°®‰∏≠')
  }
}

// Â§ÑÁêÜÁßªÈô§Êï∞ÊçÆÈõÜ
const handleRemoveDataset = (datasetId: string) => {
  selectedDatasets.value = selectedDatasets.value.filter(d => d.id !== datasetId)
}

// Â§ÑÁêÜÈ¢ÑËßàÊï∞ÊçÆÈõÜ
const handlePreviewDataset = (dataset: Dataset) => {
  // ÊâìÂºÄÊï∞ÊçÆÈõÜÈ¢ÑËßàÂØπËØùÊ°Ü
  if (datasetListRef.value && datasetListRef.value.openPreviewDialog) {
    datasetListRef.value.openPreviewDialog(dataset)
  }
}

// ÊªöÂä®Âà∞Â∫ïÈÉ®
const scrollToBottom = (smooth = true) => {
  nextTick(() => {
    if (contentArea.value) {
      contentArea.value.scrollTo({
        top: contentArea.value.scrollHeight,
        behavior: smooth ? 'smooth' : 'auto'
      })
    }
  })
}

// ÁõëÂê¨ÊªöÂä®‰∫ã‰ª∂ÔºåÂà§Êñ≠ÊòØÂê¶ÊòæÁ§∫"ÊªöÂä®Âà∞Â∫ïÈÉ®"ÊåâÈíÆ
const handleScroll = () => {
  if (!contentArea.value) return

  const { scrollTop, scrollHeight, clientHeight } = contentArea.value
  const distanceFromBottom = scrollHeight - scrollTop - clientHeight

  console.log('Scroll event:', { scrollTop, scrollHeight, clientHeight, distanceFromBottom })

  // Â¶ÇÊûúË∑ùÁ¶ªÂ∫ïÈÉ®Ë∂ÖËøá200pxÔºåÊòæÁ§∫ÊåâÈíÆ
  showScrollToBottom.value = distanceFromBottom > 200
  console.log('Show scroll button:', showScrollToBottom.value)
}

// ÁõëÂê¨ÂÜÖÂÆπÂèòÂåñÔºåËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
watch([streamingAnalysis, messageList, hasData], () => {
  // Â¶ÇÊûúÁî®Êà∑Ê≤°ÊúâÂêë‰∏äÊªöÂä®ÔºàÊåâÈíÆÊú™ÊòæÁ§∫ÔºâÔºåÂàôËá™Âä®ÊªöÂä®
  if (!showScrollToBottom.value) {
    scrollToBottom(true)
  }
}, { flush: 'post' })

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂ÁßªÈô§ÊªöÂä®ÁõëÂê¨
onUnmounted(() => {
  if (contentArea.value) {
    contentArea.value.removeEventListener('scroll', handleScroll)
  }
})

// ËæÖÂä©ÂáΩÊï∞ÔºöÊ†ºÂºèÂåñÊ∂àÊÅØÊó∂Èó¥ÔºàÂπ¥ÊúàÊó• Êó∂:ÂàÜÔºâ
const formatMessageTime = (isoString: string) => {
  if (!isoString) return ''

  const date = new Date(isoString)
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  const hours = String(date.getHours()).padStart(2, '0')
  const minutes = String(date.getMinutes()).padStart(2, '0')

  return `${year}/${month}/${day} ${hours}:${minutes}`
}

// ËæÖÂä©ÂáΩÊï∞ÔºöÊ†πÊçÆÂõæË°®Êï∞ÊçÆÊûÑÂª∫EChartsÈÖçÁΩÆ
const buildChartOptions = (chartData: any) => {
  if (!chartData) return {}

  const refinedData = chartData.refined_data
  const data = chartData.data
  const chartType = chartData.chart_type || 'bar'
  const visualizationType = chartData.visualization_type

  console.log('ÊûÑÂª∫ÂõæË°®ÈÄâÈ°π - ÂéüÂßãÊï∞ÊçÆ:', data)
  console.log('ÊûÑÂª∫ÂõæË°®ÈÄâÈ°π - refined_data:', refinedData)
  console.log('ÊûÑÂª∫ÂõæË°®ÈÄâÈ°π - chartType:', chartType)
  console.log('ÊûÑÂª∫ÂõæË°®ÈÄâÈ°π - visualizationType:', visualizationType)

  if (!data || data.length === 0) {
    console.warn('ÂõæË°®Êï∞ÊçÆ‰∏∫Á©∫')
    return {}
  }

  // ÂØπ‰∫étableÁ±ªÂûãÊàñÊ≤°Êúârefined_dataÁöÑÊÉÖÂÜµÔºåÂ∞ùËØïËá™Âä®ÊûÑÂª∫ÂõæË°®ÈÖçÁΩÆ
  if (!refinedData || visualizationType === 'table') {
    console.log('Ê≤°Êúârefined_dataÊàñ‰∏∫tableÁ±ªÂûãÔºåËá™Âä®Êé®Êñ≠Êï∞ÊçÆÁªìÊûÑ')

    const columns = Object.keys(data[0])
    if (columns.length === 0) return {}

    // ÊâæÂà∞Êï∞ÂÄºÂàóÂíåÈùûÊï∞ÂÄºÂàó - Â§öË°åÈááÊ†∑(Ââç10Ë°å)ÔºåÈÅøÂÖç‰ªÖÈ¶ñË°å‰∏∫Á©∫ÂØºËá¥ËØØÂà§
    const sampleSize = Math.min(10, data.length)
    const isNumericValue = (v: any) => {
      if (v === null || v === undefined || v === '') return false
      if (typeof v === 'number') return !isNaN(v) && isFinite(v)
      if (typeof v === 'string') {
        const num = parseFloat(v)
        return !isNaN(num) && isFinite(num)
      }
      return false
    }
    const blacklistSubstrings = ['dataset', 'dataset_id', 'source', 'source_id']
    const isBlacklisted = (name: string) => {
      const n = String(name || '').toLowerCase()
      return blacklistSubstrings.some(sub => n.includes(sub))
    }

    const numericColumns = columns.filter(col => {
      let numericCount = 0
      for (let i = 0; i < sampleSize; i++) {
        if (isNumericValue(data[i][col])) numericCount++
      }
      // Ëá≥Â∞ë‰∏ÄÂçäÊ†∑Êú¨‰∏∫Êï∞ÂÄºÂàôÂà§‰∏∫Êï∞ÂÄºÂàó
      return numericCount >= Math.ceil(sampleSize / 2)
    })

    const categoryColumns = columns.filter(col => !numericColumns.includes(col))

    console.log('Êï∞ÂÄºÂàó:', numericColumns)
    console.log('ÂàÜÁ±ªÂàó:', categoryColumns)

    // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÂÄºÂàóÔºåÊó†Ê≥ïÁîüÊàêÂõæË°®
    if (numericColumns.length === 0) {
      console.warn('Ê≤°ÊúâÊâæÂà∞Êï∞ÂÄºÂàóÔºåÊó†Ê≥ïÁîüÊàêÂõæË°®')
      return {}
    }

    // ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÂàÜÁ±ªÂàó‰Ωú‰∏∫xËΩ¥ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàÜÁ±ªÂàóÂàô‰ΩøÁî®Á¥¢Âºï
    const xAxisColumn = categoryColumns.length > 0 ? categoryColumns[0] : 'index'
    const xAxisData = xAxisColumn === 'index'
      ? data.map((_: any, index: number) => `È°πÁõÆ${index + 1}`)
      : data.map((item: any) => String(item[xAxisColumn] || ''))

    // ËøáÊª§ÈªëÂêçÂçïÂàóÂêéÔºå‰ΩøÁî®ÊúÄÂ§öÂâç10‰∏™Êï∞ÂÄºÂàó‰Ωú‰∏∫yËΩ¥
    const candidateNumericColumns = numericColumns.filter(col => !isBlacklisted(col))
    const yAxisColumns = candidateNumericColumns.slice(0, 10)
    const seriesData = yAxisColumns.map((col: string) => {
      const seriesValues = data.map((item: any) => {
        const value = item[col]
        if (value === null || value === undefined || value === '') return 0
        const numValue = Number(value)
        return isNaN(numValue) ? 0 : numValue
      })

      return {
        name: col,
        type: chartType,
        data: seriesValues,
        stack: chartType === 'bar' ? 'x' : undefined,
        areaStyle: chartType === 'line' ? {} : undefined
      }
    })

    console.log('Ëá™Âä®ÊûÑÂª∫ÁöÑxËΩ¥Êï∞ÊçÆ:', xAxisData)
    console.log('Ëá™Âä®ÊûÑÂª∫ÁöÑÁ≥ªÂàóÊï∞ÊçÆ:', seriesData)

    return {
      xAxis: {
        type: 'category' as const,
        data: xAxisData,
      },
      yAxis: {
        type: 'value' as const,
      },
      series: seriesData,
      legend: {
        data: yAxisColumns
      },
      tooltip: {
        trigger: 'axis' as const
      }
    }
  }

  // È™åËØÅrefined_dataÁöÑÊúâÊïàÊÄß
  if (!data.some((item: any) => item.hasOwnProperty(refinedData.x_axis))) {
    console.warn(`xËΩ¥Â≠óÊÆµ ${refinedData.x_axis} Âú®Êï∞ÊçÆ‰∏≠‰∏çÂ≠òÂú®ÔºåÂõûÈÄÄÂà∞Ëá™Âä®Êé®Êñ≠`)
    return buildChartOptions({ data, refined_data: null, chart_type: chartType, visualization_type: 'chart' })
  }

  const invalidYAxes = refinedData.y_axes.filter((yAxis: string) =>
    !data.some((item: any) => item.hasOwnProperty(yAxis))
  )

  if (invalidYAxes.length > 0) {
    console.warn(`yËΩ¥Â≠óÊÆµ ${invalidYAxes.join(', ')} Âú®Êï∞ÊçÆ‰∏≠‰∏çÂ≠òÂú®ÔºåÂõûÈÄÄÂà∞Ëá™Âä®Êé®Êñ≠`)
    return buildChartOptions({ data, refined_data: null, chart_type: chartType, visualization_type: 'chart' })
  }

  // ÂéüÊúâÁöÑrefined_dataÂ§ÑÁêÜÈÄªËæë
  const xAxisData = data.map((item: any) => String(item[refinedData.x_axis] || ''))
  const seriesData = refinedData.y_axes.map((yAxis: string) => {
    const seriesValues = data.map((item: any) => {
      const value = item[yAxis]
      if (value === null || value === undefined || value === '') return 0
      const numValue = Number(value)
      return isNaN(numValue) ? 0 : numValue
    })

    return {
      name: yAxis,
      type: chartType,
      data: seriesValues,
      stack: chartType === 'bar' ? 'x' : undefined,
      areaStyle: chartType === 'line' ? {} : undefined
    }
  })

  console.log('‰ΩøÁî®refined_dataÊûÑÂª∫ÁöÑxËΩ¥Êï∞ÊçÆ:', xAxisData)
  console.log('‰ΩøÁî®refined_dataÊûÑÂª∫ÁöÑÁ≥ªÂàóÊï∞ÊçÆ:', seriesData)

  return {
    xAxis: {
      type: 'category' as const,
      data: xAxisData,
    },
    yAxis: {
      type: 'value' as const,
    },
    series: seriesData,
    legend: {
      data: refinedData.y_axes
    },
    tooltip: {
      trigger: 'axis' as const
    }
  }
}

// Â§ÑÁêÜÂõæË°®Á±ªÂûãÂèòÊõ¥
const handleChartTypeChange = (message: Message, newType: string) => {
  console.log('ÂõæË°®Á±ªÂûãÂèòÊõ¥:', newType)
  if (message.chart_data) {
    message.chart_data.chart_type = newType
  }
}

// ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÂØπËØùÁöÑÊâÄÊúâÊ∂àÊÅØÔºàÊµÅÂºèËæìÂá∫ÂÆåÊàêÂêéË∞ÉÁî®Ôºâ
const reloadConversationMessages = async () => {
  if (!currentConversationId.value) return

  try {
    console.log('ÈáçÊñ∞Âä†ËΩΩÂØπËØùÊ∂àÊÅØ:', currentConversationId.value)
    const response = await axios.get(
      `${import.meta.env.VITE_API_BASE_URL}/api/conversation/${currentConversationId.value}/messages`
    )

    if (response.data.success) {
      const messages = response.data.messages
      messageList.value = messages
      console.log('ÂØπËØùÊ∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºåÂÖ±', messages.length, 'Êù°')

      // Ê∏ÖÈô§‰∏¥Êó∂Ê∂àÊÅØÔºàÂ∑≤Áªè‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩ‰∫ÜÁúüÂÆûÊ∂àÊÅØÔºâ
      tempUserMessage.value = null
      tempAiMessage.value = null
      isStreaming.value = false
      
      // ÈáçÁΩÆÊ¥ûÂØüÂàÜÊûêÁä∂ÊÄÅÔºåÁ°Æ‰øùÂéÜÂè≤Ê¥ûÂØüÂàÜÊûêËÉΩÊ≠£Á°ÆÊòæÁ§∫
      isAnalysisLoading.value = false
      isAnalysisComplete.value = true

      // ÊªöÂä®Âà∞Â∫ïÈÉ®
      nextTick(() => {
        scrollToBottom(true)
      })
    }
  } catch (error) {
    console.error('ÈáçÊñ∞Âä†ËΩΩÂØπËØùÊ∂àÊÅØÂ§±Ë¥•:', error)
  }
}

// ÁîüÊàêÂØπËØùÊ†áÈ¢òÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
const generateConversationTitleIfNeeded = async () => {
  try {
    if (!currentConversationId.value || !lastUserMessage.value) {
      return
    }

    // Ë∞ÉÁî®ÂêéÁ´ØAPIÁîüÊàêÊ†áÈ¢ò
    const response = await axios.post(
      `${import.meta.env.VITE_API_BASE_URL}/api/conversation/generate_title`,
      {
        conversation_id: currentConversationId.value,
        user_question: lastUserMessage.value
      }
    )

    if (response.data.success && response.data.updated) {
      console.log('ÂØπËØùÊ†áÈ¢òÂ∑≤Ëá™Âä®ÁîüÊàê:', response.data.title)
      // Ëß¶Âèë‰ºöËØùÂàóË°®Âà∑Êñ∞
      conversationHistoryRef.value?.refreshConversations()
    }
  } catch (error) {
    console.error('ÁîüÊàêÂØπËØùÊ†áÈ¢òÂ§±Ë¥•:', error)
    // Â§±Ë¥•‰∏çÂΩ±Âìç‰∏ªÊµÅÁ®ãÔºåÈùôÈªòÂ§ÑÁêÜ
  }
}

// ËÆ¢ÈòÖËøõÂ∫¶Êõ¥Êñ∞
const subscribeToProgress = (taskId: string) => {
  console.log('ËÆ¢ÈòÖËøõÂ∫¶Êõ¥Êñ∞:', taskId)

  const eventSource = new EventSource(`${import.meta.env.VITE_API_BASE_URL}/api/progress/${taskId}`)

  eventSource.onmessage = (event) => {
    try {
      const progressData = JSON.parse(event.data)
      console.log('Êî∂Âà∞ËøõÂ∫¶Êõ¥Êñ∞:', progressData)

      // Êõ¥Êñ∞ÂΩìÂâçÊ≠•È™§
      if (progressData.step) {
        currentProcessingStep.value = progressData.step
      }

      // Êõ¥Êñ∞ÈîôËØØÁä∂ÊÄÅ
      if (progressData.error) {
        processingError.value = progressData.message || 'Â§ÑÁêÜËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ'
      } else {
        processingError.value = ''
      }

      // Â¶ÇÊûúËøõÂ∫¶ÂÆåÊàêÔºåÂÖ≥Èó≠ËøûÊé•
      if (progressData.progress === 100 || progressData.error) {
        eventSource.close()
      }
    } catch (error) {
      console.error('Ëß£ÊûêËøõÂ∫¶Êï∞ÊçÆÂ§±Ë¥•:', error)
    }
  }

  eventSource.onerror = (error) => {
    console.error('ËøõÂ∫¶ËÆ¢ÈòÖËøûÊé•ÈîôËØØ:', error)
    eventSource.close()
  }

  // 30ÁßíÂêéËá™Âä®ÂÖ≥Èó≠ËøûÊé•
  setTimeout(() => {
    if (eventSource.readyState !== EventSource.CLOSED) {
      eventSource.close()
    }
  }, 30000)
}

// Â§ÑÁêÜÈÄâÊã©ÂéÜÂè≤ÂØπËØù
const handleSelectConversation = async (conversationId: number) => {
  console.log('ÈÄâ‰∏≠ÂéÜÂè≤ÂØπËØù:', conversationId)

  // Á´ãÂç≥Ê∏ÖÁ©∫È°µÈù¢Áä∂ÊÄÅ
  currentConversationId.value = conversationId
  isLoading.value = true
  hasStartedChat.value = false
  messageList.value = []
  hasData.value = false
  hasChartData.value = false
  streamingAnalysis.value = ''
  insightAnalysis.value = null
  responseTime.value = null
  lastUserMessage.value = ''
  tempUserMessage.value = null
  tempAiMessage.value = null
  isStreaming.value = false

  try {
    // ‰ªéÂêéÁ´ØÂä†ËΩΩÂØπËØùÁöÑÊâÄÊúâÊ∂àÊÅØ
    const response = await axios.get(
      `${import.meta.env.VITE_API_BASE_URL}/api/conversation/${conversationId}/messages`
    )

    if (response.data.success) {
      const messages = response.data.messages
      console.log('Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØ:', messages)

      // Â¶ÇÊûúÊ∂àÊÅØÂàóË°®‰∏∫Á©∫ÔºåÊòæÁ§∫ÂàùÂßãÁä∂ÊÄÅ
      if (messages.length === 0) {
        console.log('‰ºöËØùÊ∂àÊÅØÂàóË°®‰∏∫Á©∫ÔºåÊòæÁ§∫ÂàùÂßãÁä∂ÊÄÅ')
      } else {
        // ÊúâÊ∂àÊÅØÔºåÂàáÊç¢Âà∞ÂØπËØùËßÜÂõæÔºåÊòæÁ§∫Ê∂àÊÅØÂàóË°®
        hasStartedChat.value = true
        messageList.value = messages
        hasData.value = true

        // Âä†ËΩΩÂÆåÊàêÂêéÊªöÂä®Âà∞Â∫ïÈÉ®
        nextTick(() => {
          scrollToBottom(false) // Á´ãÂç≥ÊªöÂä®Ôºå‰∏ç‰ΩøÁî®Âä®Áîª
        })
      }
    }
  } catch (error) {
    console.error('Âä†ËΩΩÂéÜÂè≤ÂØπËØùÂ§±Ë¥•:', error)
    // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
    messageList.value = []
    hasData.value = false
    hasStartedChat.value = false
  } finally {
    isLoading.value = false
  }
}
</script>

<style scoped>
/* ‰∏ªÂÆπÂô® - Âç†Êª°Áà∂ÂÖÉÁ¥† */
.home-container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

/* ÂàùÂßãÁä∂ÊÄÅËßÜÂõæ - ‰∏ä‰∏ãÂ∏ÉÂ±Ä */
.initial-view {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

/* Â±Ö‰∏≠ÂÜÖÂÆπÂÆπÂô® */
.center-content {
  flex: 1;
  width: 100%;
  max-width: 48rem;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2rem;
  padding: 1rem;
}

/* Ê¨¢ËøéÂç°ÁâáÂå∫Âüü */
.welcome-section {
  width: 100%;
}

/* ËæìÂÖ•Ê°ÜÂ±Ö‰∏≠Âå∫Âüü */
.input-center-section {
  width: 100%;
}

.input-center-wrapper {
  width: 100%;
}

/* ÂàùÂßãÁä∂ÊÄÅÂ∫ïÈÉ®ÂÖçË¥£Â£∞Êòé */
.disclaimer-footer-initial {
  position: absolute;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  text-align: center;
  background: transparent;
  padding: 0.5rem 1rem;
}

/* ÂàùÂßãÁä∂ÊÄÅ - È°∂ÈÉ®Â∑•ÂÖ∑Ê†è */
.top-toolbar {
  flex-shrink: 0;
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.5rem;
  background: white;
  border: none;
}

.toolbar-left {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.toolbar-right {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* ÂØπËØùÁä∂ÊÄÅËßÜÂõæÂÆπÂô® */
.conversation-view {
  flex: 1;
  position: relative;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ÂØπËØùÁä∂ÊÄÅ - È°∂ÈÉ®Â∑•ÂÖ∑Ê†è */
.top-toolbar-conversation {
  flex-shrink: 0;
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.5rem;
  background: white;
  border: none;
}

.new-chat-btn {
  flex-shrink: 0;
}

/* ÂØπËØùËßÜÂõæ - ÂÜÖÂÆπÂå∫ + ËæìÂÖ•Ê°Ü */
.content-area {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
}

.content-wrapper {
  width: 100%;
  max-width: 64rem;
  margin: 0 auto;
  padding: 2rem 1rem 6rem 1rem;
}

.messages-list {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.message-item {
  width: 100%;
}

/* Áî®Êà∑Ê∂àÊÅØ - Âè≥ÂØπÈΩê */
.user-message {
  display: flex;
  justify-content: flex-end;
}

.user-bubble {
  max-width: 80%;
  padding: 0.75rem 1.25rem;
  background-color: rgb(var(--v-theme-primary));
  color: rgb(var(--v-theme-on-primary));
  border-radius: 1rem;
  border-top-right-radius: 0.125rem;
  word-wrap: break-word;
  word-break: break-word;
  overflow-wrap: break-word;
  box-sizing: border-box;
}

.user-bubble p {
  margin: 0;
  word-wrap: break-word;
  word-break: break-word;
  overflow-wrap: break-word;
}

/* AIÊ∂àÊÅØ - Â∑¶ÂØπÈΩê */
.ai-message {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.chart {
  width: 100%;
  height: 24rem;
}

.loading-state {
  text-align: center;
  padding: 2rem 0;
}

.action-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.25rem;
}

.action-buttons {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.action-icon-btn {
  opacity: 0.4;
  transition: opacity 0.2s ease;
}

.action-icon-btn:hover {
  opacity: 0.7;
}

.time-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-left: auto;
}

.message-time {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.75rem;
  color: rgba(var(--v-theme-on-surface), 0.6);
  white-space: nowrap;
}

.response-time {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.75rem;
  color: rgba(var(--v-theme-on-surface), 0.6);
  white-space: nowrap;
}

/* ÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆÂÆπÂô® */
.scroll-to-bottom-container {
  position: fixed;
  bottom: 160px;
  /* ËæìÂÖ•Ê°Ü‰∏äÊñπÔºåÈÄÇÂ∫îÊõ¥Â∞èÁöÑËæìÂÖ•Ê°Ü */
  right: 2rem;
  /* Êîπ‰∏∫Âè≥‰æßÂØπÈΩêÔºåÊõ¥ÊòéÊòæ */
  z-index: 2001;
  /* ÊèêÈ´òz-indexÁ°Æ‰øùÂú®ÊâÄÊúâÂÜÖÂÆπ‰∏äÊñπ */
  pointer-events: none;
  /* ËÆ©ÂÆπÂô®Êú¨Ë∫´‰∏çÈòªÊå°ÁÇπÂáª */
}

.scroll-to-bottom-btn {
  pointer-events: auto;
  /* ÊÅ¢Â§çÊåâÈíÆÁöÑÁÇπÂáª */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border-radius: 24px;
}

/* ÊåâÈíÆÊ∑°ÂÖ•Ê∑°Âá∫Âä®Áîª */
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.3s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}

/* ËæìÂÖ•Ê°ÜÂå∫Âüü - Âõ∫ÂÆöÂ∫ïÈÉ® */
.input-bar {
  flex-shrink: 0;
  background-color: rgb(var(--v-theme-background));
  padding: 0.75rem 1rem;
  padding-bottom: 0;
  /* ‰∏∫ÂÖçË¥£Â£∞ÊòéËÖæÂá∫Á©∫Èó¥ */
}

/* ÂØπËØùÁä∂ÊÄÅ‰∏ãËæìÂÖ•Ê°ÜÊõ¥Á¥ßÂáë */
.input-bar :deep(.chat-input-wrapper) {
  padding: 0.5rem 1rem;
}

.input-bar :deep(.input-area) {
  font-size: 0.875rem;
  min-height: 1.5rem;
}

.input-wrapper {
  width: 100%;
  max-width: 64rem;
  margin: 0 auto;
}

/* Â∫ïÈÉ®ÂÖçË¥£Â£∞Êòé - ÈÄèÊòé */
.disclaimer-footer {
  flex-shrink: 0;
  background: transparent;
  text-align: center;
  padding: 0.5rem 1rem;
}

/* ÂõæË°®ÂàáÊç¢ÊåâÈíÆÁªÑÊ†∑Âºè */
.chart-toggle-group {
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.chart-toggle-btn {
  border-radius: 0 !important;
  transition: all 0.2s ease;
  font-weight: 500;
}

.chart-toggle-group :deep(.v-btn--active) {
  background-color: rgba(var(--v-theme-primary), 0.1) !important;
  color: rgb(var(--v-theme-primary)) !important;
}

.chart-toggle-group :deep(.v-btn:not(.v-btn--active)) {
  background-color: rgba(var(--v-theme-surface), 1) !important;
  color: rgba(var(--v-theme-on-surface), 0.8) !important;
  border: 1px solid rgba(var(--v-theme-outline), 0.2) !important;
}

.chart-toggle-group :deep(.v-btn:hover:not(.v-btn--active)) {
  background-color: rgba(var(--v-theme-primary), 0.05) !important;
  color: rgba(var(--v-theme-on-surface), 0.9) !important;
  border-color: rgba(var(--v-theme-primary), 0.3) !important;
}

/* Ê¥ûÂØüÂàÜÊûêÂç°ÁâáÊ†∑Âºè */
.insight-analysis-card {
  border: 1px solid rgba(var(--v-theme-primary), 0.2);
  background: linear-gradient(135deg, rgba(var(--v-theme-primary), 0.05) 0%, rgba(var(--v-theme-surface), 1) 100%);
}

.insight-analysis-card .v-card-title {
  background: rgba(var(--v-theme-primary), 0.1);
  font-weight: 600;
}

/* È™®Êû∂Â±èÊ†∑Âºè */
.insight-skeleton {
  animation: pulse 1.5s ease-in-out infinite;
}

/* ÊµÅÂºèÂÜÖÂÆπÊ†∑Âºè */
.streaming-content {
  position: relative;
}

/* ÊâìÂ≠óÊú∫ÂÖâÊ†áÊïàÊûú */
.typing-cursor {
  display: inline-block;
  background-color: rgb(var(--v-theme-primary));
  width: 2px;
  height: 1.2em;
  margin-left: 2px;
  animation: blink 1s infinite;
}

@keyframes blink {

  0%,
  50% {
    opacity: 1;
  }

  51%,
  100% {
    opacity: 0;
  }
}

@keyframes pulse {

  0%,
  100% {
    opacity: 1;
  }

  50% {
    opacity: 0.7;
  }
}

/* ÈùôÊÄÅÂÜÖÂÆπÊ†∑Âºè */
.static-content {
  opacity: 1;
  transition: opacity 0.3s ease;
}

.disclaimer-text {
  font-size: 0.75rem;
  color: rgba(var(--v-theme-on-surface), 0.5);
  opacity: 0.8;
}

/* ÂìçÂ∫îÂºè */
@media (min-width: 640px) {
  .center-content {
    padding: 2rem;
  }
}

/* ÁßªÂä®Á´Ø‰ºòÂåñÊªöÂä®ÊåâÈíÆ */
@media (max-width: 768px) {
  .scroll-to-bottom-container {
    right: 1rem;
    bottom: 140px;
  }

  .scroll-to-bottom-btn {
    font-size: 0.875rem;
  }
}
</style>
