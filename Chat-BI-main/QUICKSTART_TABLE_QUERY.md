# 表格查询功能快速开始指南

## 🚀 立即开始

### 1. 检查并修复配置

```bash
cd backend

# 检查并重置Qdrant collection（如果需要）
python reset_qdrant.py
```

**预期输出:**
```
连接到Qdrant: http://localhost:6333
找到collection: chatbi_columns
当前向量维度: 1536
配置的向量维度: 4096
维度不匹配! collection使用1536维，配置要求4096维
删除旧collection...
✅ 旧collection已删除
```

### 2. 启动服务

```bash
# 终端1 - 后端
cd backend
conda activate chatbi
python main.py

# 终端2 - 前端
cd frontend
pnpm dev
```

### 3. 上传数据集

1. 访问 http://localhost:3000
2. 点击右上角数据集图标
3. 上传CSV或Excel文件
4. 等待解析完成（会自动生成embeddings）

### 4. 开始提问

点击数据集卡片选中数据集，然后输入问题：

**简单问题:**
- "这里面有多少行数据？"
- "显示前10行数据"
- "主要包含什么内容？"

**统计问题:**
- "统计各类别的数量"
- "按地区汇总销售额"
- "最高的前10个是哪些？"

**趋势问题:**
- "过去3个月的趋势"
- "同比增长情况"

## 🎯 功能亮点

### 1. 实时进度显示

提问后会看到5个处理步骤：
```
✓ 意图识别 - 分析用户问题类型...
✓ 数据检索 - 从向量数据库检索相关数据集...
⟳ SQL生成 - 生成数据查询语句...
○ 查询执行 - 执行数据查询...
○ 结果分析 - 生成图表和洞察分析...
```

### 2. 智能SQL生成

系统会自动：
- 识别你的数据集schema
- 理解你的问题意图
- 生成准确的SQL查询
- 如果失败会自动回退到规则模板

### 3. 多种可视化

根据数据自动选择：
- 📊 柱状图 - 分类对比
- 📈 折线图 - 趋势分析
- 🥧 饼图 - 占比分析

### 4. AI洞察分析

每次查询后会提供：
- 🔍 关键发现
- 💡 深度解读
- 📈 业务启示
- 🎯 关注要点

## ⚠️ 常见问题

### Q1: 显示"向量检索失败"

**原因:** Qdrant collection维度配置错误

**解决:**
```bash
cd backend
python reset_qdrant.py
# 然后重新上传数据集
```

### Q2: SQL查询总是失败

**检查清单:**
- [ ] 数据集是否成功上传？
- [ ] 是否选中了数据集？
- [ ] 后端日志中的SQL语句是什么？

**解决:**
查看后端日志，如果SQL包含`table_name`占位符，说明回退机制未生效。
检查`backend/api/endpoints/generate_chart.py`中的`generate_fallback_sql`函数。

### Q3: 进度指示器不显示

**检查:**
- [ ] 是否选中了数据集？（没选中会进入普通对话模式）
- [ ] 浏览器控制台是否有错误？
- [ ] `ProcessingSteps.vue`组件是否正确导入？

### Q4: 事务错误

如果看到`current transaction is aborted`错误：

**已修复:** 最新代码已添加自动回滚机制

**验证修复:**
```python
# 在 backend/api/utils/db_utils.py 中查找:
await async_session.rollback()
# 应该出现在 except 块中
```

## 📊 测试示例数据

### 销售数据示例 (sales_data.csv)

```csv
日期,产品,类别,销售额,数量
2024-01-01,产品A,电子产品,15000,50
2024-01-01,产品B,家居用品,8000,80
2024-01-02,产品A,电子产品,12000,40
2024-01-02,产品C,电子产品,20000,30
```

**测试问题:**
1. "销售额最高的产品是哪个？"
2. "电子产品的总销售额是多少？"
3. "每天的销售趋势如何？"

### 用户数据示例 (user_data.csv)

```csv
姓名,年龄,城市,消费金额,注册日期
张三,25,北京,5000,2024-01-15
李四,30,上海,8000,2024-01-16
王五,28,深圳,6500,2024-01-17
赵六,35,广州,12000,2024-01-18
```

**测试问题:**
1. "有多少用户？"
2. "各城市的用户分布"
3. "平均消费金额是多少？"

## 🔍 监控要点

### 后端日志

**正常流程:**
```
INFO - 意图分类: query (confidence: 0.95)
INFO - 检索到 5 个相关列, top similarity: 0.850
INFO - LLM生成的SQL: SELECT ...
INFO - DuckDB查询成功: 10 行
INFO - AI回复已保存: conversation_id=21
```

**异常流程（但已处理）:**
```
ERROR - SQL查询错误 (第1次尝试): ...
INFO - 事务已回滚，清除错误状态
INFO - 重新生成SQL查询语句并重试...
```

### 前端控制台

**正常输出:**
```
模式: 智慧问数
已选择数据集: [...]
Response: { data: [...], chart_type: 'bar', ... }
```

## 🎉 成功指标

系统正常工作的标志：

✅ **向量检索:**
- 能找到相关列
- 相似度 > 0.7

✅ **SQL生成:**
- 不包含`table_name`占位符
- 列名用双引号包裹
- 表名是`dataset`

✅ **查询执行:**
- 返回数据
- 无事务错误
- 响应时间 < 15秒

✅ **前端展示:**
- 进度指示器正常
- 图表渲染正常
- 洞察分析显示正常

## 📝 下一步

系统运行正常后，可以：

1. **测试更多场景** - 参考 `TESTING_GUIDE_TABLE_QUERY.md`
2. **性能优化** - 添加缓存机制
3. **功能增强** - 支持更复杂的查询
4. **用户体验** - 添加查询历史、问题推荐等

## 🆘 获取帮助

如果遇到问题：

1. 查看 `FIX_SUMMARY_TABLE_QUERY.md` 了解详细修复内容
2. 查看 `TESTING_GUIDE_TABLE_QUERY.md` 了解测试方法
3. 检查后端日志和浏览器控制台
4. 确认所有服务（PostgreSQL, Redis, Qdrant, MinIO）正常运行

## ✨ 享受智能数据问答！

现在你可以用自然语言查询你的数据了！系统会：
- 🤖 理解你的问题
- 🔍 找到相关数据
- 📊 生成可视化图表
- 💡 提供深度洞察

祝使用愉快！🎊
